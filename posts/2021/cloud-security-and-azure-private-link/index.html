<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Cloud Security And Azure Private Link - Blog</title><meta name=Description content="Exploring the disruptive world of cloud tech"><meta property="og:title" content="Cloud Security And Azure Private Link"><meta property="og:description" content="Azure Private Link enables access to hosted customer and partner services over a private endpoint in an Azure virtual network. This means private connectivity over your own RFC1918 address space to any supported PaaS service while limiting the need for additional gateways, NAT appliances, public IP addresses, or ExpressRoute (Microsoft Peering).
Hold on, wasn&rsquo;t the point of Public Cloud to leverage services offered by third-party providers over the public internet? Why, then, would we want to contain traffic in our private IP space, which is likely routable across our on-premises network?"><meta property="og:type" content="article"><meta property="og:url" content="http://wcollins.io/posts/2021/cloud-security-and-azure-private-link/"><meta property="og:image" content="http://wcollins.io/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-01-11T18:55:25-05:00"><meta property="article:modified_time" content="2021-01-11T18:55:25-05:00"><meta property="og:site_name" content="Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://wcollins.io/"><meta name=twitter:title content="Cloud Security And Azure Private Link"><meta name=twitter:description content="Azure Private Link enables access to hosted customer and partner services over a private endpoint in an Azure virtual network. This means private connectivity over your own RFC1918 address space to any supported PaaS service while limiting the need for additional gateways, NAT appliances, public IP addresses, or ExpressRoute (Microsoft Peering).
Hold on, wasn&rsquo;t the point of Public Cloud to leverage services offered by third-party providers over the public internet? Why, then, would we want to contain traffic in our private IP space, which is likely routable across our on-premises network?"><meta name=application-name content="Blog"><meta name=apple-mobile-web-app-title content="Blog"><meta name=theme-color content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><meta name=twitter:creator content="@WCollins502"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=http://wcollins.io/posts/2021/cloud-security-and-azure-private-link/><link rel=prev href=http://wcollins.io/posts/2020/automating-cloud-ipam/><link rel=next href=http://wcollins.io/posts/2021/cloud-grade-automation-with-packer-and-terraform/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><meta name=google-site-verification content="FSCEdJZD7nAoKk16ak20hRMKNBvXlnHAU0PBBDZy5DU"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Cloud Security And Azure Private Link","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"http://wcollins.io/posts/2021/cloud-security-and-azure-private-link/"},"genre":"posts","keywords":"azure, dns, iaas, paas, private endpoints, private link, public endpoints, service endpoints, saas","wordcount":3045,"url":"http://wcollins.io/posts/2021/cloud-security-and-azure-private-link/","datePublished":"2021-01-11T18:55:25-05:00","dateModified":"2021-01-11T18:55:25-05:00","publisher":{"@type":"Organization","name":"William Collins"},"author":{"@type":"Person","name":"William Collins"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"light"==="light"||"light"==="dark"||"light"==="black"?(setTheme("light"),saveTheme("light")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=Blog></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/>Home </a><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/talks/>Talks </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about>About </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=Blog></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw"></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw"></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/ title>Home</a><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/talks/ title>Talks</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#the-problem>The Problem</a><ul><li><a href=#examining-cloud-security-models>Examining Cloud Security Models</a></li><li><a href=#risky-patterns>Risky Patterns</a></li></ul></li><li><a href=#a-word-on-provider-architectures>A Word On Provider Architectures</a><ul><li><a href=#service-behavior>Service Behavior</a></li><li><a href=#resource-allocation>Resource Allocation</a></li></ul></li><li><a href=#integration>Integration</a></li><li><a href=#before-service-endpoints>Before Service Endpoints</a><ul><li><a href=#why-is-this-risky>Why Is This Risky?</a></li><li><a href=#tradeoffs>Tradeoffs</a></li></ul></li><li><a href=#vnet-integration>VNet Integration</a><ul><li><a href=#problems-solved-by-vnet-integration>Problems Solved By VNet Integration</a></li><li><a href=#vnet-integration-tradeoffs>VNet Integration Tradeoffs</a></li></ul></li><li><a href=#service-endpoints>Service Endpoints</a><ul><li><a href=#problems-solved-by-service-endpoints>Problems Solved By Service Endpoints</a></li><li><a href=#setting-up-a-service-endpoint>Setting Up A Service Endpoint</a></li><li><a href=#dns-behavior-with-service-endpoints>DNS Behavior With Service Endpoints</a></li><li><a href=#service-endpoint-tradeoffs>Service Endpoint Tradeoffs</a></li></ul></li><li><a href=#private-link>Private Link</a><ul><li><a href=#breaking-down-the-components>Breaking Down The Components</a></li><li><a href=#problems-solved-by-private-link>Problems Solved By Private Link</a></li><li><a href=#setting-up-a-private-endpoint>Setting Up A Private Endpoint</a></li><li><a href=#dns-behavior-with-private-endpoints>DNS Behavior With Private Endpoints</a></li><li><a href=#private-link-tradeoffs>Private Link Tradeoffs</a></li><li><a href=#expanding-on-dns-complexity>Expanding On DNS Complexity</a></li></ul></li><li><a href=#conclusion>Conclusion</a><ul><li><a href=#acknowledgements>Acknowledgements</a></li></ul></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Cloud Security And Azure Private Link</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class="author fas fa-user-circle fa-fw"></span><a href=/ title=Author rel=author class=author>William Collins</a>
</span>&nbsp;<span class=post-category>included in </span>&nbsp;<span class=post-category>categories <a href=/categories/cloud/><i class="far fa-folder fa-fw"></i>cloud</a>&nbsp;<a href=/categories/cloud-architecture/><i class="far fa-folder fa-fw"></i>cloud architecture</a>&nbsp;<a href=/categories/cloud-security/><i class="far fa-folder fa-fw"></i>cloud security</a>&nbsp;<a href=/categories/hybrid-cloud/><i class="far fa-folder fa-fw"></i>hybrid cloud</a>&nbsp;<a href=/categories/multi-cloud/><i class="far fa-folder fa-fw"></i>multi cloud</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="11 January 2021">11 January 2021</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime="11 January 2021">11 January 2021</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;3045 words&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;15 minutes&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#the-problem>The Problem</a><ul><li><a href=#examining-cloud-security-models>Examining Cloud Security Models</a></li><li><a href=#risky-patterns>Risky Patterns</a></li></ul></li><li><a href=#a-word-on-provider-architectures>A Word On Provider Architectures</a><ul><li><a href=#service-behavior>Service Behavior</a></li><li><a href=#resource-allocation>Resource Allocation</a></li></ul></li><li><a href=#integration>Integration</a></li><li><a href=#before-service-endpoints>Before Service Endpoints</a><ul><li><a href=#why-is-this-risky>Why Is This Risky?</a></li><li><a href=#tradeoffs>Tradeoffs</a></li></ul></li><li><a href=#vnet-integration>VNet Integration</a><ul><li><a href=#problems-solved-by-vnet-integration>Problems Solved By VNet Integration</a></li><li><a href=#vnet-integration-tradeoffs>VNet Integration Tradeoffs</a></li></ul></li><li><a href=#service-endpoints>Service Endpoints</a><ul><li><a href=#problems-solved-by-service-endpoints>Problems Solved By Service Endpoints</a></li><li><a href=#setting-up-a-service-endpoint>Setting Up A Service Endpoint</a></li><li><a href=#dns-behavior-with-service-endpoints>DNS Behavior With Service Endpoints</a></li><li><a href=#service-endpoint-tradeoffs>Service Endpoint Tradeoffs</a></li></ul></li><li><a href=#private-link>Private Link</a><ul><li><a href=#breaking-down-the-components>Breaking Down The Components</a></li><li><a href=#problems-solved-by-private-link>Problems Solved By Private Link</a></li><li><a href=#setting-up-a-private-endpoint>Setting Up A Private Endpoint</a></li><li><a href=#dns-behavior-with-private-endpoints>DNS Behavior With Private Endpoints</a></li><li><a href=#private-link-tradeoffs>Private Link Tradeoffs</a></li><li><a href=#expanding-on-dns-complexity>Expanding On DNS Complexity</a></li></ul></li><li><a href=#conclusion>Conclusion</a><ul><li><a href=#acknowledgements>Acknowledgements</a></li></ul></li></ul></nav></div></div><div class=content id=content><p><a href=https://azure.microsoft.com/en-us/services/private-link/ target=_blank rel="noopener noreferrer">Azure Private Link</a> enables access to <em>hosted</em> customer and <em>partner</em> services over a private endpoint in an Azure virtual network. This means private connectivity over your own <a href=https://tools.ietf.org/html/rfc1918 target=_blank rel="noopener noreferrer">RFC1918</a> address space to any supported <a href=https://azure.microsoft.com/en-us/overview/what-is-paas/ target=_blank rel="noopener noreferrer">PaaS</a> service while limiting the need for additional gateways, NAT appliances, public IP addresses, or <a href=https://docs.microsoft.com/en-us/azure/expressroute/expressroute-circuit-peerings#microsoftpeering target=_blank rel="noopener noreferrer">ExpressRoute (Microsoft Peering)</a>.</p><p>Hold on, wasn&rsquo;t the point of <a href=https://azure.microsoft.com/en-us/overview/what-is-a-public-cloud/ target=_blank rel="noopener noreferrer">Public Cloud</a> to leverage services offered by <em>third-party</em> providers over the public internet? Why, then, would we want to contain traffic in our private IP space, which is likely routable across our on-premises network? Let&rsquo;s examine this a little deeper to understand the problem we are aiming to solve, solutions available today, some complexities introduced with <em>Private Link</em>, and why we wouldn&rsquo;t just use PaaS services <em>as is</em>.</p><blockquote><p>Microsoft announced Private Link <a href="https://azure.microsoft.com/en-us/blog/announcing-azure-private-link/#:~:text=With%20today%27s%20announcement%2C%20you%20can,using%20simple%20clicks%20and%20approval" target=_blank rel="noopener noreferrer">(Preview)</a> in 2019 becoming generally available in <a href=https://azure.microsoft.com/en-us/updates/private-link-now-available-in-ga/ target=_blank rel="noopener noreferrer">early 2020</a>. AWS released their flavor of <a href="https://aws.amazon.com/privatelink/?privatelink-blogs.sort-by=item.additionalFields.createdDate&privatelink-blogs.sort-order=desc" target=_blank rel="noopener noreferrer">Private Link</a> back in 2017. <a href=https://cloud.google.com/ target=_blank rel="noopener noreferrer">Google Cloud</a> released <a href=https://cloud.google.com/blog/products/networking/introducing-private-service-connect target=_blank rel="noopener noreferrer">Private Service Connect</a> in 2020.</p></blockquote><p><figure><a class=lightgallery href=/posts/2021/cloud-security-and-azure-private-link/private-link-overview.png title="Azure Private Link - Overview" data-thumbnail=/posts/2021/cloud-security-and-azure-private-link/private-link-overview.png data-sub-html="<h2>Overview</h2><p>Azure Private Link - Overview</p>"><img loading=lazy src=/posts/2021/cloud-security-and-azure-private-link/private-link-overview.png srcset="/posts/2021/cloud-security-and-azure-private-link/private-link-overview.png, /posts/2021/cloud-security-and-azure-private-link/private-link-overview.png 1.5x, /posts/2021/cloud-security-and-azure-private-link/private-link-overview.png 2x" sizes=auto alt="Azure Private Link - Overview" height=831 width=1427></a><figcaption class=image-caption>Overview</figcaption></figure></p><h2 id=the-problem class=headerLink><a href=#the-problem class=header-mark></a>The Problem</h2><p>Leveraging <a href=https://azure.microsoft.com/en-us/overview/what-is-paas/ target=_blank rel="noopener noreferrer">PaaS</a> services is kind of like owning a home. Except in that home, you don&rsquo;t have to fix cracks in the foundation, patch that leaky roof, clean the garage, or even mow the lawn. PaaS services significantly reduce infrastructure management and increase agility while simplifying your ability to scale. Security-focused teams will usually identify the following as problems when talking <em>PaaS</em>:</p><ul><li>The risk of <strong>data leakage / exfiltration</strong> increases as PaaS integration with <a href=https://azure.microsoft.com/en-us/overview/what-is-iaas/ target=_blank rel="noopener noreferrer">IaaS</a> and on-premises environments increase</li><li>Decreasing or eliminating <strong>internet exposure</strong> is preferred; Azure PaaS services were originally available via public IP addresses only</li><li>Anything that runs over a network that isn&rsquo;t your own private <em>WAN</em> is risky and must be <strong>avoided</strong></li></ul><blockquote><p>While I understand and share concerns with risk here, these are generally obstacles I have run into with various security teams throughout my time in tech. I can look back on some tough conversations in the past when trying to advocate for <a href=https://www.cisco.com/c/en/us/solutions/enterprise-networks/sd-wan/what-is-sd-wan.html target=_blank rel="noopener noreferrer">SD-WAN</a>. Since it went over the <em>internet</em>, it couldn&rsquo;t be reliable and introduced significant <em>risk</em> to the business. Fast-forward to <em>2021</em> especially in the current state of the <a href=https://www.cdc.gov/coronavirus/2019-ncov/index.html target=_blank rel="noopener noreferrer">COVID-19</a> pandemic; most large enterprises now declare <em>internet</em> as the new network, <em>public cloud</em> as the new data center, and <em>identity</em> as the new perimeter.</p></blockquote><h3 id=examining-cloud-security-models class=headerLink><a href=#examining-cloud-security-models class=header-mark></a>Examining Cloud Security Models</h3><p>Our scope here is <em>security in the cloud</em>, not <em>security of the cloud</em>. Security considerations differ in the cloud by service model. In descending through each service model&rsquo;s different layers, the responsibility for security shifts between Customer and Provider.</p><p>For example, with <a href=https://azure.microsoft.com/en-us/overview/what-is-saas/ target=_blank rel="noopener noreferrer">SaaS</a>, the layers a customer is responsible for is relatively small; data and access/identity are considered. As you move into <a href=https://azure.microsoft.com/en-us/overview/what-is-paas/ target=_blank rel="noopener noreferrer">PaaS</a>, the application layer, along with some platform configuration, comes into play. Moving into <a href=https://azure.microsoft.com/en-us/overview/what-is-iaas/ target=_blank rel="noopener noreferrer">IaaS</a>, the operating system is now customer responsibility, along with all the layers above.</p><p><figure><a class=lightgallery href=/posts/2021/cloud-security-and-azure-private-link/security-models.png title="Security Models" data-thumbnail=/posts/2021/cloud-security-and-azure-private-link/security-models.png data-sub-html="<h2>Security Models</h2><p>Security Models</p>"><img loading=lazy src=/posts/2021/cloud-security-and-azure-private-link/security-models.png srcset="/posts/2021/cloud-security-and-azure-private-link/security-models.png, /posts/2021/cloud-security-and-azure-private-link/security-models.png 1.5x, /posts/2021/cloud-security-and-azure-private-link/security-models.png 2x" sizes=auto alt="Security Models" height=2064 width=3816></a><figcaption class=image-caption>Security Models</figcaption></figure></p><blockquote><p>When you have a nice mixture of the three cloud layers and the full gamut of all things data center, thinking through the security domain becomes complicated quickly. Add some <a href=https://en.wikipedia.org/wiki/Multicloud target=_blank rel="noopener noreferrer">Multi-Cloud</a> to this venue, and you are in for a real party.</p></blockquote><h3 id=risky-patterns class=headerLink><a href=#risky-patterns class=header-mark></a>Risky Patterns</h3><p>In the <em>Digital Era</em>, privacy is at the top of the list. This is especially true when considering specific regulations like <a href=https://gdpr.eu/ target=_blank rel="noopener noreferrer">GDPR</a> or <a href=https://www.cdc.gov/phlp/publications/topic/hipaa.html target=_blank rel="noopener noreferrer">HIPAA</a>. A data leak can cause a significant loss in revenue and long-term damage to your brand. Specific patterns can expose the number of porous areas, contributing to possible data leakage if not appropriately hardened.</p><ul><li><a href=https://azure.microsoft.com/en-us/product-categories/identity/ target=_blank rel="noopener noreferrer"><strong>Identity & Access Management <em>(IAM)</em></strong></a> - Access based on identity authentication and authorization controls; The ground floor for establishing <a href=https://www.microsoft.com/en-us/security/business/zero-trust target=_blank rel="noopener noreferrer">Zero Trust</a> in the public cloud</li><li><strong>Cloud Endpoints to On-Premises</strong> - Services in public cloud provider&rsquo;s managed network need to make calls to on-premises <em>private networks</em></li><li><strong>On-Premises to Cloud Endpoints</strong> - Exact opposite of the first pattern; Services in public cloud provider&rsquo;s managed network need to be called from an on-premises <em>private network</em></li><li><strong>Internet Egress</strong> - Any point of internet exit; A sinister concoction of data center places, <em>properly designed</em> cloud places, <em>shadow IT</em> <strong>oops</strong> cloud places, and&mldr; plenty of other venues just south of anyone&rsquo;s radar</li></ul><h2 id=a-word-on-provider-architectures class=headerLink><a href=#a-word-on-provider-architectures class=header-mark></a>A Word On Provider Architectures</h2><p>For <em>public cloud</em> to achieve the massive <em>scale-out</em> which accommodates customer growth, <em>cloud services</em> are built on large pools of resources (network, compute, and storage). This large pool of resources is managed by a centralized <a href="https://en.wikipedia.org/wiki/Control_plane#:~:text=In%20computing%2C%20the%20control%20plane,that%20processes%20the%20data%20requests." target=_blank rel="noopener noreferrer">control plane</a>. As demand increases, additional <em>resources</em> are added to the pool to increase capacity.</p><h3 id=service-behavior class=headerLink><a href=#service-behavior class=header-mark></a>Service Behavior</h3><p>There are ultimately two ways in which services can be categorized based on <em>networking</em> behavior. Since this write-up is <em>Azure</em> focused, I&rsquo;ll map <em>Azure</em> specific constructs into the examples:</p><p><strong>Public Services</strong> is typically what we think of when referencing <em>PaaS</em>. Public Services are consumed over the internet, reachable via <em>public IP addresses</em>, and are not provisioned in the customer&rsquo;s <em>VNet</em>. An example of a <em>public service</em> would be <a href=https://azure.microsoft.com/en-us/services/storage/ target=_blank rel="noopener noreferrer">Azure Storage</a>.</p><p><strong>Private Services</strong> by default, are not reachable over the internet. Services are assigned <a href=https://tools.ietf.org/html/rfc1918 target=_blank rel="noopener noreferrer">RFC1918</a> addresses and are deployed directly inside a customer&rsquo;s virtual network. An example of a <em>private service</em> would be an <a href=https://azure.microsoft.com/en-us/services/virtual-machines/ target=_blank rel="noopener noreferrer">Azure Virtual Machine</a>.</p><h3 id=resource-allocation class=headerLink><a href=#resource-allocation class=header-mark></a>Resource Allocation</h3><p>When customers provision a service, the <em>control plane</em> will create an <em>instance</em> of the service. Resources are then allocated accordingly. There are generally two ways in which a <em>service</em> can allocate resources to an <em>instance</em>:</p><p><strong>Shared Services</strong> - Resources are allocated to more than one service instance; Each instance consumes resources <em>simultaneously</em>.</p><p><strong>Dedicated Services</strong> - Resources are allocated to a single instance; These resources remain dedicated for the <em>instance&rsquo;s</em> entire <em>lifecycle</em>.</p><p><figure><a class=lightgallery href=/posts/2021/cloud-security-and-azure-private-link/service-allocation-patterns.png title="Service Allocation" data-thumbnail=/posts/2021/cloud-security-and-azure-private-link/service-allocation-patterns.png data-sub-html="<h2>Service Allocation</h2><p>Service Allocation</p>"><img loading=lazy src=/posts/2021/cloud-security-and-azure-private-link/service-allocation-patterns.png srcset="/posts/2021/cloud-security-and-azure-private-link/service-allocation-patterns.png, /posts/2021/cloud-security-and-azure-private-link/service-allocation-patterns.png 1.5x, /posts/2021/cloud-security-and-azure-private-link/service-allocation-patterns.png 2x" sizes=auto alt="Service Allocation" height=2025 width=2668></a><figcaption class=image-caption>Service Allocation</figcaption></figure></p><h2 id=integration class=headerLink><a href=#integration class=header-mark></a>Integration</h2><p>Suppose you are going through the cloud migration journey. In that case, you may have some strategy that includes a combination of <a href=https://aws.amazon.com/blogs/enterprise-strategy/6-strategies-for-migrating-applications-to-the-cloud/ target=_blank rel="noopener noreferrer">rehost, replatform, and refactor.</a> At some point, you will probably be faced with integrating cloud <a href=https://azure.microsoft.com/en-us/overview/what-is-paas/ target=_blank rel="noopener noreferrer">PaaS</a> services with <a href=https://azure.microsoft.com/en-us/overview/what-is-iaas/ target=_blank rel="noopener noreferrer">IaaS</a> and even back <em>on-premises</em>.</p><h2 id=before-service-endpoints class=headerLink><a href=#before-service-endpoints class=header-mark></a>Before Service Endpoints</h2><p><a href=https://docs.microsoft.com/en-us/azure/azure-sql/database/sql-database-paas-overview/ target=_blank rel="noopener noreferrer">Azure SQL DB</a> is a great way to migrate your SQL Server databases without changing your apps, making it extremely popular. Before Service Endpoints came along, how would a <a href=https://azure.microsoft.com/en-us/services/virtual-machines/ target=_blank rel="noopener noreferrer">virtual machine</a> communicate to Azure SQL?</p><ul><li>Azure SQL DB is available via public IP address and listens on port 1433</li><li>The virtual machine has direct connectivity to the internet via NAT&rsquo;ed IP address</li><li>The virtual machine leverages this for internet egress to reach Azure SQL service</li><li>Azure SQL service sees the NAT&rsquo;ed IP address, not the private IP of the virtual machine</li><li>No restrictions can be enforced to limit service ingress to your private IP addresses only</li></ul><h3 id=why-is-this-risky class=headerLink><a href=#why-is-this-risky class=header-mark></a>Why Is This Risky?</h3><p>To filter traffic in this scenario, the virtual machine would need a public IP address. This presents the following complications:</p><ul><li>Virtual Machine now allows ingress directly from the internet (This is never a good practice)</li><li>The subnet that hosts the virtual machine would require a NAT gateway; More configuration with potential performance implications</li><li>Azure SQL would need to be open to clients on any network; In the event credentials are leaked, anyone on the internet could gain access</li></ul><h3 id=tradeoffs class=headerLink><a href=#tradeoffs class=header-mark></a>Tradeoffs</h3><p>Aside from being inflexible in controlling <em>ingress</em> and <em>egress</em> traffic, the route is not optimal. Traffic is technically going out to the internet, but this is probably, in reality, routing through Azure&rsquo;s external backbone and coming back in. The service is reachable via public IP address only. Considering the design and various integrations required to make it work, there could be significant opportunities for data leakage or exfiltration.</p><h2 id=vnet-integration class=headerLink><a href=#vnet-integration class=header-mark></a>VNet Integration</h2><p><a href=https://docs.microsoft.com/en-us/azure/app-service/web-sites-integrate-with-vnet target=_blank rel="noopener noreferrer">VNet Integration</a> is leveraged for services whose design matches the <em>dedicated services</em> architecture. Also called <em>VNet Injection</em>, this method deploys a given service directly in your <em>VNet</em>. As a solution, it enables better continuity for workloads operating in <em>tiered hybrid</em> design.</p><p><figure><a class=lightgallery href=/posts/2021/cloud-security-and-azure-private-link/vnet-integration-diagram.png title="VNet Integration" data-thumbnail=/posts/2021/cloud-security-and-azure-private-link/vnet-integration-diagram.png data-sub-html="<h2>VNet Integration</h2><p>VNet Integration</p>"><img loading=lazy src=/posts/2021/cloud-security-and-azure-private-link/vnet-integration-diagram.png srcset="/posts/2021/cloud-security-and-azure-private-link/vnet-integration-diagram.png, /posts/2021/cloud-security-and-azure-private-link/vnet-integration-diagram.png 1.5x, /posts/2021/cloud-security-and-azure-private-link/vnet-integration-diagram.png 2x" sizes=auto alt="VNet Integration" height=2145 width=2340></a><figcaption class=image-caption>VNet Integration</figcaption></figure></p><h3 id=problems-solved-by-vnet-integration class=headerLink><a href=#problems-solved-by-vnet-integration class=header-mark></a>Problems Solved By VNet Integration</h3><ul><li><em>Injected</em> services are exposed over <a href=https://tools.ietf.org/html/rfc1918 target=_blank rel="noopener noreferrer">RFC1918</a> addresses directly from your VNet</li><li>As a dedicated platform, none of the components are shared across other customers; This could be a requirement in some cases</li><li>At the <em>network layer</em>, the behavior would be similar to that of a virtual machine in the same <em>VNet</em></li><li>Communication to virtual machines in same <em>VNet</em> and in <a href=https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-peering-overview target=_blank rel="noopener noreferrer">peered VNets</a> is <em>bidirectional</em></li><li>Communication between on-premises environments over <a href=https://docs.microsoft.com/en-us/azure/expressroute/expressroute-circuit-peerings#privatepeering target=_blank rel="noopener noreferrer">ExpressRoute - Private Peering</a> or VPNs is <em>bidirectional</em></li><li>Inbound connections from routable IP addresses outside of VNet address space is possible when exposed behind public IP address; Best to use an <a href="https://docs.microsoft.com/en-us/azure/load-balancer/quickstart-load-balancer-standard-public-portal?tabs=option-1-create-load-balancer-standard" target=_blank rel="noopener noreferrer">external load balancer</a> / front-end IP address</li><li><a href=https://docs.microsoft.com/en-us/azure/load-balancer/load-balancer-outbound-connections target=_blank rel="noopener noreferrer">VNet Source NAT</a> can be used to initiate connections to internet routable IP addresses</li></ul><h3 id=vnet-integration-tradeoffs class=headerLink><a href=#vnet-integration-tradeoffs class=header-mark></a>VNet Integration Tradeoffs</h3><p>Although <em>VNet Integration</em> was created to deploy <a href=https://azure.microsoft.com/en-us/services/app-service/web/ target=_blank rel="noopener noreferrer">App Services</a> privately, is all of it really private and <em>exclusive</em> to only your <em>VNet</em>? While the service itself is dedicated, the control plane managing the services is not. Integrated services require inbound and outbound connections to <em>platform managed</em> public IP addresses, which facilitate interaction to the <em>control plane</em>. Whether this is a tradeoff is debatable.</p><ul><li>Integrated services are deployed into an <em>isolated</em> subnet; Services contain <a href=https://docs.microsoft.com/en-us/azure/app-service/environment/network-info#ase-subnet-size target=_blank rel="noopener noreferrer">sizing guidlines</a></li><li>Each service identifies the required dependencies for control plane communication; For example, <a href=https://docs.microsoft.com/en-us/azure/app-service/environment/intro target=_blank rel="noopener noreferrer">App Service Environment</a> dependencies can be found <a href=https://docs.microsoft.com/en-us/azure/app-service/environment/network-info#ase-dependencies target=_blank rel="noopener noreferrer">here</a></li><li>Increased complexity in managing <a href=https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview target=_blank rel="noopener noreferrer">NSGs</a> and <a href=https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-udr-overview#user-defined target=_blank rel="noopener noreferrer">UDRs</a>; <a href=https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview#service-tags target=_blank rel="noopener noreferrer">Service Tags</a> should be used to reduce overhead as the mapping between tag and addresses are automatically managed by the platform</li><li>Ultimately, each service will exhibit different behavior and likely has different requirements; Always consult the official documentation</li></ul><h2 id=service-endpoints class=headerLink><a href=#service-endpoints class=header-mark></a>Service Endpoints</h2><p><a href=https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview target=_blank rel="noopener noreferrer">Service Endpoints</a> as a solution can be applied to select <em>PaaS</em> services with a <em>shared architecture</em>. A route is created from your <em>PaaS</em> service into the desired <em>VNets</em>.</p><p><figure><a class=lightgallery href=/posts/2021/cloud-security-and-azure-private-link/service-endpoints-diagram.png title="Service Endpoints" data-thumbnail=/posts/2021/cloud-security-and-azure-private-link/service-endpoints-diagram.png data-sub-html="<h2>Service Endpoints</h2><p>Service Endpoints</p>"><img loading=lazy src=/posts/2021/cloud-security-and-azure-private-link/service-endpoints-diagram.png srcset="/posts/2021/cloud-security-and-azure-private-link/service-endpoints-diagram.png, /posts/2021/cloud-security-and-azure-private-link/service-endpoints-diagram.png 1.5x, /posts/2021/cloud-security-and-azure-private-link/service-endpoints-diagram.png 2x" sizes=auto alt="Service Endpoints" height=2153 width=2597></a><figcaption class=image-caption>Service Endpoints</figcaption></figure></p><h3 id=problems-solved-by-service-endpoints class=headerLink><a href=#problems-solved-by-service-endpoints class=header-mark></a>Problems Solved By Service Endpoints</h3><ul><li>After enabling a service endpoint in the subnet where the <a href=https://azure.microsoft.com/en-us/services/application-gateway/ target=_blank rel="noopener noreferrer">Application Gateway</a> is deployed, source IP addresses switch from public to private IP addresses</li><li>Traffic from a given virtual machine in a private subnet can now talk directly to Azure SQL without requiring internet egress; Without a public IP address, bad actors can&rsquo;t scan a virtual machine&rsquo;s open ports for vulnerabilities, thus limiting application downtime and data theft</li><li>Service Endpoints ensure traffic egressing a given subnet is tagged with the subnet ID; Traffic inbound to Azure SQL can then be identified and blocked except for your desired subnet IDs (like the subnet which hosts the service endpoint)</li><li>An <a href=https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview target=_blank rel="noopener noreferrer">NSG</a> can then restrict all egress traffic from the subnet to the internet, thus locking down communication both ways</li><li>Connecting to Azure Services from your VNet happens with an optimized route over Azure&rsquo;s internal backbone network; This reduces network hops, which increases performance (In most cases)</li></ul><h3 id=setting-up-a-service-endpoint class=headerLink><a href=#setting-up-a-service-endpoint class=header-mark></a>Setting Up A Service Endpoint</h3><p>When provisioning a compatible service like <a href=https://azure.microsoft.com/en-us/services/key-vault/ target=_blank rel="noopener noreferrer">Azure Keyvault</a>, you will have an option to use <strong><em>Public Endpoint (Selected Networks)</em></strong> during the setup process. It will then walk you through enabling <em>service endpoints</em> on your desired virtual network and subnet.</p><p><figure><a class=lightgallery href=/posts/2021/cloud-security-and-azure-private-link/service-endpoint-setup.gif title="Service Endpoint Setup" data-thumbnail=/posts/2021/cloud-security-and-azure-private-link/service-endpoint-setup.gif data-sub-html="<h2>Setup</h2><p>Service Endpoint Setup</p>"><img loading=lazy src=/posts/2021/cloud-security-and-azure-private-link/service-endpoint-setup.gif srcset="/posts/2021/cloud-security-and-azure-private-link/service-endpoint-setup.gif, /posts/2021/cloud-security-and-azure-private-link/service-endpoint-setup.gif 1.5x, /posts/2021/cloud-security-and-azure-private-link/service-endpoint-setup.gif 2x" sizes=auto alt="Service Endpoint Setup" height=1261 width=1256></a><figcaption class=image-caption>Setup</figcaption></figure></p><h3 id=dns-behavior-with-service-endpoints class=headerLink><a href=#dns-behavior-with-service-endpoints class=header-mark></a>DNS Behavior With Service Endpoints</h3><p><a href=https://en.wikipedia.org/wiki/Domain_Name_System target=_blank rel="noopener noreferrer">DNS</a> behavior remains <em>as-is</em> when leveraging <em>service endpoints</em>. DNS of a given resource will always resolve the resource&rsquo;s public IP address regardless of where the traffic originates. This is because the <em>service endpoint</em> doesn&rsquo;t change the network interface IP address of the resource it was added to. In doing a DNS lookup from an Azure virtual machine, we get a <em>CNAME</em> to <strong><em>cloudapp.net</em></strong> which gives us <strong><em>20.185.217.251</em></strong>. This lookup is identical when being executed both from the virtual machine living in the <em>VNet</em> and on my local machine at home.</p><p><figure><a class=lightgallery href=/posts/2021/cloud-security-and-azure-private-link/se-dns-query.gif title="Service Endpoints DNS Query" data-thumbnail=/posts/2021/cloud-security-and-azure-private-link/se-dns-query.gif data-sub-html="<h2>DNS Query</h2><p>Service Endpoints DNS Query</p>"><img loading=lazy src=/posts/2021/cloud-security-and-azure-private-link/se-dns-query.gif srcset="/posts/2021/cloud-security-and-azure-private-link/se-dns-query.gif, /posts/2021/cloud-security-and-azure-private-link/se-dns-query.gif 1.5x, /posts/2021/cloud-security-and-azure-private-link/se-dns-query.gif 2x" sizes=auto alt="Service Endpoints DNS Query" height=518 width=1178></a><figcaption class=image-caption>DNS Query</figcaption></figure></p><h3 id=service-endpoint-tradeoffs class=headerLink><a href=#service-endpoint-tradeoffs class=header-mark></a>Service Endpoint Tradeoffs</h3><p>Leveraging service endpoints is an excellent way to harden your VNet and service communication; As with everything in technology, it has tradeoffs to consider.</p><ul><li>Connection initiation with service endpoints is <em>unidirectional</em>; The initiator must be inside the subnet that holds the integration</li><li>From a VNet&rsquo;s vantage point, <em>service endpoints</em> provide access to the entire <em>PaaS</em> service; You cannot target specific <em>instances</em> of a PaaS service</li><li>Once enabled on a <em>subnet</em>, clients in the subnet have <em>network level</em> access to all instances of that particular service (including those belonging to other users); To mitigate the risk of leakage or data exfiltration, <a href=https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoint-policies-overview target=_blank rel="noopener noreferrer">Service Endpoint Policies</a> should be used<blockquote><p>Service Endpoint Policies enable VNet owners to control precisely which <em>instances</em> of a service type can be accessed from their VNet</p></blockquote></li><li>The source is now a private IP address, but the destination is still the service resource&rsquo;s public IP address; Traffic is still leaving your virtual network (Whether this is a tradeoff is debatable)</li><li>Service Endpoints override any <a href=https://en.wikipedia.org/wiki/Border_Gateway_Protocol target=_blank rel="noopener noreferrer">BGP</a> or <a href=https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-udr-overview target=_blank rel="noopener noreferrer">UDR</a> routes for the address prefix match of any Azure service; While this isn&rsquo;t necessarily a problem, it introduces another traffic pattern that must be accounted for<blockquote><p>When a <em>service endpoint</em> is created, routes for all the public prefixes used by the service type get added to the subnet&rsquo;s route table. The <em>next-hop</em> is set to a value of <strong>VirtualNetworkServiceEndpoint</strong>. All packets that match that <em>next hop</em> are encapsulated in outer packets, which carry information about the identity of their source <em>virtual network</em>.</p></blockquote></li><li>Service Endpoints do not work across <a href=https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-whatis target=_blank rel="noopener noreferrer">Azure AD Tenants</a>; This is not generally a problem in smaller environments but may require a workaround in larger or non-standard environments</li><li>Endpoints can&rsquo;t be used for traffic originating from on-premises networks</li></ul><blockquote><p>When service endpoints launched, the recommended solution for connecting from on-premises was to set up <a href=https://docs.microsoft.com/en-us/azure/expressroute/expressroute-circuit-peerings#microsoftpeering target=_blank rel="noopener noreferrer">Microsoft Peering</a>, which comes with additional complexity and considerations. This would involve identifying the Azure service resource side&rsquo;s public IP addresses and allowing via <em>resource IP firewall</em> and the ExpressRoute / On-Premises firewall. Why not just use <em>internet</em> at this point?</p></blockquote><h2 id=private-link class=headerLink><a href=#private-link class=header-mark></a>Private Link</h2><p>To address additional customer demand surrounding integration and security, <a href=https://azure.microsoft.com/en-us/services/private-link/ target=_blank rel="noopener noreferrer">Private Link</a> was born. It is the latest solution to integrate services with a <em>shared architecture</em>. It addresses limitations of <em>service endpoints</em> by exposing <em>PaaS</em> services via <em>private IP addresses</em> taken from a VNets <a href=https://tools.ietf.org/html/rfc1918 target=_blank rel="noopener noreferrer">RFC1918</a> space.</p><p><figure><a class=lightgallery href=/posts/2021/cloud-security-and-azure-private-link/private-link-diagram.png title="Private Link" data-thumbnail=/posts/2021/cloud-security-and-azure-private-link/private-link-diagram.png data-sub-html="<h2>Private Link</h2><p>Private Link</p>"><img loading=lazy src=/posts/2021/cloud-security-and-azure-private-link/private-link-diagram.png srcset="/posts/2021/cloud-security-and-azure-private-link/private-link-diagram.png, /posts/2021/cloud-security-and-azure-private-link/private-link-diagram.png 1.5x, /posts/2021/cloud-security-and-azure-private-link/private-link-diagram.png 2x" sizes=auto alt="Private Link" height=2151 width=3004></a><figcaption class=image-caption>Private Link</figcaption></figure></p><h3 id=breaking-down-the-components class=headerLink><a href=#breaking-down-the-components class=header-mark></a>Breaking Down The Components</h3><ul><li><a href=https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview target=_blank rel="noopener noreferrer"><strong>Virtual Networks</strong> <em>(VNets)</em></a> are created in a subscription with private address space and provide network-level containment of resources with no traffic allowed by default between any two virtual networks. Any communication between virtual networks needs to be explicitly provisioned.</li><li><a href=https://docs.microsoft.com/en-us/azure/private-link/private-endpoint-overview target=_blank rel="noopener noreferrer"><strong>Private Endpoint</strong></a> establishes a logical relationship between a public service <em>instance</em> and a <em>NIC</em> attached to the VNet where the <em>service</em> is exposed.</li><li><a href=https://azure.microsoft.com/en-us/services/private-link/ target=_blank rel="noopener noreferrer"><strong>Private Link Service</strong></a> enables you to access Azure PaaS Services over a private endpoint. Services supported today can be found <a href=https://docs.microsoft.com/en-us/azure/private-link/private-link-overview#availability target=_blank rel="noopener noreferrer">here.</a></li></ul><h3 id=problems-solved-by-private-link class=headerLink><a href=#problems-solved-by-private-link class=header-mark></a>Problems Solved By Private Link</h3><ul><li>Using a <em>private endpoint</em> enables flexible <em>PaaS</em> integration with your own <em>private</em> address space</li><li>With no public IP addresses exposed, this means network-based <em>access restrictions</em> are not so complicated or not required at all; This simplifies network design as a whole</li><li><em>Private Link</em> enables on-premises clients to use existing <a href=https://docs.microsoft.com/en-us/azure/expressroute/expressroute-circuit-peerings#privatepeering target=_blank rel="noopener noreferrer">ExpressRoute Private Peering</a> or an existing <a href=https://docs.microsoft.com/en-us/azure/architecture/reference-architectures/hybrid-networking/#vpn-connection target=_blank rel="noopener noreferrer">VPN</a> to consume <em>PaaS</em> services via <em>private</em> IP addresses</li><li>A private endpoint is mapped to an instance of a <em>PaaS</em> resource instead of the full service meaning consumers can only connect to that specific resource; This provides additional <em>built-in</em> protection against data leakage</li><li>Connectivity from a designated <em>VNet</em> to a partner (inside or outside) organization&rsquo;s <em>VNet</em> is now possible; This creates new opportunities for B2B <em>(Business-to-Business)</em> which can leverage Azure native connections without the necessity for <em>public endpoints</em></li></ul><h3 id=setting-up-a-private-endpoint class=headerLink><a href=#setting-up-a-private-endpoint class=header-mark></a>Setting Up A Private Endpoint</h3><p>Using the <a href=https://azure.microsoft.com/en-us/services/key-vault/ target=_blank rel="noopener noreferrer">Azure Keyvault</a> example again, you will have an option to use <strong><em>Private Endpoint</em></strong> during the setup process. It will then walk you through setting up all the necessary configuration for a <em>private endpoint</em> and optionally creating a <a href=https://docs.microsoft.com/en-us/azure/dns/private-dns-privatednszone target=_blank rel="noopener noreferrer">Private DNS Zone</a>. Following the defaults, it will also create the <a href=https://www.cloudflare.com/learning/dns/dns-records/dns-a-record/ target=_blank rel="noopener noreferrer">A Record</a> for you.</p><p><figure><a class=lightgallery href=/posts/2021/cloud-security-and-azure-private-link/private-endpoint-setup.gif title="Private Endpoint Setup" data-thumbnail=/posts/2021/cloud-security-and-azure-private-link/private-endpoint-setup.gif data-sub-html="<h2>Setup</h2><p>Private Endpoint Setup</p>"><img loading=lazy src=/posts/2021/cloud-security-and-azure-private-link/private-endpoint-setup.gif srcset="/posts/2021/cloud-security-and-azure-private-link/private-endpoint-setup.gif, /posts/2021/cloud-security-and-azure-private-link/private-endpoint-setup.gif 1.5x, /posts/2021/cloud-security-and-azure-private-link/private-endpoint-setup.gif 2x" sizes=auto alt="Private Endpoint Setup" height=1261 width=1256></a><figcaption class=image-caption>Setup</figcaption></figure></p><h3 id=dns-behavior-with-private-endpoints class=headerLink><a href=#dns-behavior-with-private-endpoints class=header-mark></a>DNS Behavior With Private Endpoints</h3><p>One of the more significant differences between <em>service endpoints</em> and <em>private endpoints</em> is with <a href=https://en.wikipedia.org/wiki/Domain_Name_System target=_blank rel="noopener noreferrer">DNS</a>. In doing a DNS lookup from an Azure virtual machine, we directly resolve the private IP address <strong><em>10.5.1.4</em></strong>. If we did this same lookup from a machine outside of our <em>VNet</em> or Azure, then we would get a <em>CNAME</em> to <strong><em>cloudapp.net</em></strong> which would then give us the public IP address of the service.</p><p><figure><a class=lightgallery href=/posts/2021/cloud-security-and-azure-private-link/pe-dns-query.gif title="Private Endpoints DNS Query" data-thumbnail=/posts/2021/cloud-security-and-azure-private-link/pe-dns-query.gif data-sub-html="<h2>DNS Query</h2><p>Private Endpoints DNS Query</p>"><img loading=lazy src=/posts/2021/cloud-security-and-azure-private-link/pe-dns-query.gif srcset="/posts/2021/cloud-security-and-azure-private-link/pe-dns-query.gif, /posts/2021/cloud-security-and-azure-private-link/pe-dns-query.gif 1.5x, /posts/2021/cloud-security-and-azure-private-link/pe-dns-query.gif 2x" sizes=auto alt="Private Endpoints DNS Query" height=455 width=1319></a><figcaption class=image-caption>DNS Query</figcaption></figure></p><h3 id=private-link-tradeoffs class=headerLink><a href=#private-link-tradeoffs class=header-mark></a>Private Link Tradeoffs</h3><ul><li>Connection initiation with Private Link is <em>unidirectional</em>; The initiator can be multiple <em>VNets</em> or <em>on-premises</em> networks</li><li>As of today, NSGs are not supported on <em>private endpoints</em>; While subnets containing the <em>private endpoint</em> can have an NSG associated, the rules will not be effective on traffic being processed</li><li><a href=https://en.wikipedia.org/wiki/Domain_Name_System target=_blank rel="noopener noreferrer">DNS</a> integration is a major part of <em>Private Link</em> and brings additional complexity; Mapping design and configuration to outcomes requires significant planning</li><li>Transitioning infrastructure from <em>service endpoints</em> to <em>private endpoints</em> will require additional planning and downtime</li></ul><h3 id=expanding-on-dns-complexity class=headerLink><a href=#expanding-on-dns-complexity class=header-mark></a>Expanding On DNS Complexity</h3><p>In the most simple of scenarios, an instance of a service that supports <em>Private Link</em> can be accessed concurrently through the service&rsquo;s <em>public IP address</em> and <em>private endpoint</em> (across multiple VNets). During provisioning, each <em>instance</em> of a <em>public service</em> is assigned a unique and publicly resolvable <em>FQDN</em>. With a service operating in <em>shared architecture</em>, multiple instances run on the same set of resources sharing the same <em>IP address</em>. To handle resolution, <a href=https://en.wikipedia.org/wiki/CNAME_record target=_blank rel="noopener noreferrer">CNAME</a> records map the <em>FQDNs</em> of each instance back to the same address.</p><p><em>Private Link</em>, by design, requires DNS behavior to change based on origin - e.g., inside/outside and also based on the existence of a <em>private endpoint</em> for a given <em>instance</em>. Since, by default, the <em>FQDN</em> of the service resolves to a public IP, you would need to configure DNS accordingly to map to the <em>private IP address</em> allocated from your <em>VNet</em>. This is a topic that should be planned out prior to leveraging this service. One consistent <em>truth</em> I have learned working in technology is, <strong><em>Some of the most bizarre problems leading to colossal time waste turn out to be misconfigured DNS</em></strong>. A great way to get ahead of these challenges is to <a href=https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances#name-resolution-that-uses-your-own-dns-server target=_blank rel="noopener noreferrer">educate on how name resolution for resources in Azure works</a> and also know your options for <a href=https://docs.microsoft.com/en-us/azure/private-link/private-endpoint-dns#on-premises-workloads-using-a-dns-forwarder target=_blank rel="noopener noreferrer">integrating with on-premises DNS.</a></p><h2 id=conclusion class=headerLink><a href=#conclusion class=header-mark></a>Conclusion</h2><p><a href=https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview target=_blank rel="noopener noreferrer">Service Endpoints</a> as a solution is easier to set up and manage, although integration with on-premises can be a challenge. <a href=https://azure.microsoft.com/en-us/services/private-link/ target=_blank rel="noopener noreferrer">Private Link</a> is much more complex and will differ across environments. Deploying <em>Private Link</em> will require much more up-front discovery and planning around existing design, which also segues into <em>infrastructure as code</em> and possibly incorporating automation outside of <a href=https://azure.microsoft.com/en-us/ target=_blank rel="noopener noreferrer">Azure</a> - (If leveraging existing DNS solution).</p><p><a href=https://en.wikipedia.org/wiki/Benjamin_Franklin target=_blank rel="noopener noreferrer">Benjamin Franklin</a> once said, <strong><em>&ldquo;By failing to prepare, you are preparing to fail.&rdquo;</em></strong> By taking that extra preparation, <em>Private Link</em> can offer much more granular control with how <em>PaaS</em> services are integrated into an environment. In the state of <em>Cybersecurity</em> post-pandemic, I predict that all the major cloud providers will <em>prioritize</em> the <em>privatization</em> of all <em>PaaS</em> endpoints.</p><h3 id=acknowledgements class=headerLink><a href=#acknowledgements class=header-mark></a>Acknowledgements</h3><p>Big thanks to the wise and insightful <a href=https://www.linkedin.com/in/sthawkins/ target=_blank rel="noopener noreferrer">Steven Hawkins</a> for taking the time to peer review this post.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 11 January 2021</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-mardown href=/posts/2021/cloud-security-and-azure-private-link/index.md target=_blank rel="noopener noreferrer">Read markdown</a></span></div><div class=post-info-share></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/azure/>azure</a>,&nbsp;<a href=/tags/dns/>dns</a>,&nbsp;<a href=/tags/iaas/>iaas</a>,&nbsp;<a href=/tags/paas/>paas</a>,&nbsp;<a href=/tags/private-endpoints/>private endpoints</a>,&nbsp;<a href=/tags/private-link/>private link</a>,&nbsp;<a href=/tags/public-endpoints/>public endpoints</a>,&nbsp;<a href=/tags/service-endpoints/>service endpoints</a>,&nbsp;<a href=/tags/saas/>saas</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/2020/automating-cloud-ipam/ class=prev rel=prev title="AnsibleFest 2020 - Automating IPAM In Cloud"><i class="fas fa-angle-left fa-fw"></i>AnsibleFest 2020 - Automating IPAM In Cloud</a>
<a href=/posts/2021/cloud-grade-automation-with-packer-and-terraform/ class=next rel=next title="Cloud Grade Automation With Packer and Terraform">Cloud Grade Automation With Packer and Terraform<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2019 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank rel="noopener noreferrer">William Collins</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},search:{distance:null,findAllMatches:null,fuseIndexURL:"/index.json",highlightTag:"em",ignoreFieldNorm:null,ignoreLocation:null,isCaseSensitive:null,location:null,maxResultLength:10,minMatchCharLength:null,noResultsFound:"No results found",snippetLength:30,threshold:null,type:"fuse",useExtendedSearch:null}}</script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-9QKVT40M3H")</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-9QKVT40M3H" async></script></div></body></html>