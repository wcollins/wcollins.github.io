<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<title>Cloud Security And Azure Private Link - </title>
<meta name=renderer content="webkit">
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<meta http-equiv=cache-control content="no-transform">
<meta http-equiv=cache-control content="no-siteapp">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=author content="William Collins"><meta name=description content="Azure Private Link enables access to hosted customer and partner services over a private endpoint in an Azure virtual network. This means private connectivity over your own RFC1918 address space to any supported PaaS service while limiting the need for additional gateways, NAT appliances, public IP addresses, or ExpressRoute (Microsoft Peering).
Hold on, wasn&amp;rsquo;t the point of Public Cloud to leverage services offered by third-party providers over the public internet? Why, then, would we want to contain traffic in our private IP space, which is likely routable across our on-premises network?">
<meta name=google-site-verification content="FSCEdJZD7nAoKk16ak20hRMKNBvXlnHAU0PBBDZy5DU">
<meta name=generator content="Hugo 0.87.0 with theme even">
<link rel=canonical href=http://wcollins.io/post/2021/cloud-security-and-azure-private-link/>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png>
<link rel=manifest href=/manifest.json>
<link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5>
<link href=/sass/main.min.8c3cbcb0324c2bb4875ceccba4007cbad4b4ac8377f33af9953c3e7684534a50.css rel=stylesheet>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous>
<meta property="og:title" content="Cloud Security And Azure Private Link">
<meta property="og:description" content="Azure Private Link enables access to hosted customer and partner services over a private endpoint in an Azure virtual network. This means private connectivity over your own RFC1918 address space to any supported PaaS service while limiting the need for additional gateways, NAT appliances, public IP addresses, or ExpressRoute (Microsoft Peering).
Hold on, wasn&rsquo;t the point of Public Cloud to leverage services offered by third-party providers over the public internet? Why, then, would we want to contain traffic in our private IP space, which is likely routable across our on-premises network?">
<meta property="og:type" content="article">
<meta property="og:url" content="http://wcollins.io/post/2021/cloud-security-and-azure-private-link/"><meta property="article:section" content="post">
<meta property="article:published_time" content="2021-01-11T18:55:25-05:00">
<meta property="article:modified_time" content="2021-01-11T18:55:25-05:00">
<meta itemprop=name content="Cloud Security And Azure Private Link">
<meta itemprop=description content="Azure Private Link enables access to hosted customer and partner services over a private endpoint in an Azure virtual network. This means private connectivity over your own RFC1918 address space to any supported PaaS service while limiting the need for additional gateways, NAT appliances, public IP addresses, or ExpressRoute (Microsoft Peering).
Hold on, wasn&rsquo;t the point of Public Cloud to leverage services offered by third-party providers over the public internet? Why, then, would we want to contain traffic in our private IP space, which is likely routable across our on-premises network?"><meta itemprop=datePublished content="2021-01-11T18:55:25-05:00">
<meta itemprop=dateModified content="2021-01-11T18:55:25-05:00">
<meta itemprop=wordCount content="3050">
<meta itemprop=keywords content="azure,dns,iaas,paas,private endpoints,private link,public endpoints,service endpoints,saas,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Cloud Security And Azure Private Link">
<meta name=twitter:description content="Azure Private Link enables access to hosted customer and partner services over a private endpoint in an Azure virtual network. This means private connectivity over your own RFC1918 address space to any supported PaaS service while limiting the need for additional gateways, NAT appliances, public IP addresses, or ExpressRoute (Microsoft Peering).
Hold on, wasn&rsquo;t the point of Public Cloud to leverage services offered by third-party providers over the public internet? Why, then, would we want to contain traffic in our private IP space, which is likely routable across our on-premises network?"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo></a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<a href=/>
<li class=mobile-menu-item>Home</li>
</a><a href=/about/>
<li class=mobile-menu-item>About</li>
</a><a href=/post/>
<li class=mobile-menu-item>Archives</li>
</a><a href=/tags/>
<li class=mobile-menu-item>Tags</li>
</a><a href=/categories/>
<li class=mobile-menu-item>Categories</li>
</a>
</ul>
</nav>
<div class=container id=mobile-panel>
<header id=header class=header>
<div class=logo-wrapper>
<a href=/ class=logo></a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=/>Home</a>
</li><li class=menu-item>
<a class=menu-item-link href=/about/>About</a>
</li><li class=menu-item>
<a class=menu-item-link href=/post/>Archives</a>
</li><li class=menu-item>
<a class=menu-item-link href=/tags/>Tags</a>
</li><li class=menu-item>
<a class=menu-item-link href=/categories/>Categories</a>
</li>
</ul>
</nav>
</header>
<main id=main class=main>
<div class=content-wrapper>
<div id=content class=content>
<article class=post>
<header class=post-header>
<h1 class=post-title>Cloud Security And Azure Private Link</h1>
<div class=post-meta>
<span class=post-time> January 11, 2021 </span>
<div class=post-category>
<a href=/categories/cloud/> cloud </a>
<a href=/categories/cloud-architecture/> cloud architecture </a>
<a href=/categories/cloud-security/> cloud security </a>
<a href=/categories/hybrid-cloud/> hybrid cloud </a>
<a href=/categories/multi-cloud/> multi cloud </a>
</div>
<span class=more-meta> 3050 words </span>
<span class=more-meta> 15 mins read </span>
</div>
</header>
<div class=post-toc id=post-toc>
<h2 class=post-toc-title>Contents</h2>
<div class=post-toc-content>
<nav id=TableOfContents>
<ul>
<li>
<ul>
<li><a href=#the-problem>The Problem</a>
<ul>
<li><a href=#examining-cloud-security-models>Examining Cloud Security Models</a></li>
<li><a href=#risky-patterns>Risky Patterns</a></li>
</ul>
</li>
<li><a href=#a-word-on-provider-architectures>A Word On Provider Architectures</a>
<ul>
<li><a href=#service-behavior>Service Behavior</a></li>
<li><a href=#resource-allocation>Resource Allocation</a></li>
</ul>
</li>
<li><a href=#integration>Integration</a></li>
<li><a href=#before-service-endpoints>Before Service Endpoints</a>
<ul>
<li><a href=#why-is-this-risky>Why Is This Risky?</a></li>
<li><a href=#tradeoffs>Tradeoffs</a></li>
</ul>
</li>
<li><a href=#vnet-integration>VNet Integration</a>
<ul>
<li><a href=#problems-solved-by-vnet-integration>Problems Solved By VNet Integration</a></li>
<li><a href=#vnet-integration-tradeoffs>VNet Integration Tradeoffs</a></li>
</ul>
</li>
<li><a href=#service-endpoints>Service Endpoints</a>
<ul>
<li><a href=#problems-solved-by-service-endpoints>Problems Solved By Service Endpoints</a></li>
<li><a href=#setting-up-a-service-endpoint>Setting Up A Service Endpoint</a></li>
<li><a href=#dns-behavior-with-service-endpoints>DNS Behavior With Service Endpoints</a></li>
<li><a href=#service-endpoint-tradeoffs>Service Endpoint Tradeoffs</a></li>
</ul>
</li>
<li><a href=#private-link>Private Link</a>
<ul>
<li><a href=#breaking-down-the-components>Breaking Down The Components</a></li>
<li><a href=#problems-solved-by-private-link>Problems Solved By Private Link</a></li>
<li><a href=#setting-up-a-private-endpoint>Setting Up A Private Endpoint</a></li>
<li><a href=#dns-behavior-with-private-endpoints>DNS Behavior With Private Endpoints</a></li>
<li><a href=#private-link-tradeoffs>Private Link Tradeoffs</a></li>
<li><a href=#expanding-on-dns-complexity>Expanding On DNS Complexity</a></li>
</ul>
</li>
<li><a href=#conclusion>Conclusion</a>
<ul>
<li><a href=#acknowledgements>Acknowledgements</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</div>
<div class=post-content>
<p><a href=https://azure.microsoft.com/en-us/services/private-link/>Azure Private Link</a> enables access to <em>hosted</em> customer and <em>partner</em> services over a private endpoint in an Azure virtual network. This means private connectivity over your own <a href=https://tools.ietf.org/html/rfc1918>RFC1918</a> address space to any supported <a href=https://azure.microsoft.com/en-us/overview/what-is-paas/>PaaS</a> service while limiting the need for additional gateways, NAT appliances, public IP addresses, or <a href=https://docs.microsoft.com/en-us/azure/expressroute/expressroute-circuit-peerings#microsoftpeering>ExpressRoute (Microsoft Peering)</a>.</p>
<p>Hold on, wasn&rsquo;t the point of <a href=https://azure.microsoft.com/en-us/overview/what-is-a-public-cloud/>Public Cloud</a> to leverage services offered by <em>third-party</em> providers over the public internet? Why, then, would we want to contain traffic in our private IP space, which is likely routable across our on-premises network? Let&rsquo;s examine this a little deeper to understand the problem we are aiming to solve, solutions available today, some complexities introduced with <em>Private Link</em>, and why we wouldn&rsquo;t just use PaaS services <em>as is</em>.</p>
<blockquote>
<p>Microsoft announced Private Link <a href="https://azure.microsoft.com/en-us/blog/announcing-azure-private-link/#:~:text=With%20today%27s%20announcement%2C%20you%20can,using%20simple%20clicks%20and%20approval">(Preview)</a> in 2019 becoming generally available in <a href=https://azure.microsoft.com/en-us/updates/private-link-now-available-in-ga/>early 2020</a>. AWS released their flavor of <a href="https://aws.amazon.com/privatelink/?privatelink-blogs.sort-by=item.additionalFields.createdDate&privatelink-blogs.sort-order=desc">Private Link</a> back in 2017. <a href=https://cloud.google.com/>Google Cloud</a> released <a href=https://cloud.google.com/blog/products/networking/introducing-private-service-connect>Private Service Connect</a> in 2020.</p>
</blockquote>
<p><img src=/images/2021/cloud-security-and-azure-private-link/private-link-overview.png alt="Azure Private Link - Overview"></p>
<h2 id=the-problem>The Problem</h2>
<p>Leveraging <a href=https://azure.microsoft.com/en-us/overview/what-is-paas/>PaaS</a> services is kind of like owning a home. Except in that home, you don&rsquo;t have to fix cracks in the foundation, patch that leaky roof, clean the garage, or even mow the lawn. PaaS services significantly reduce infrastructure management and increase agility while simplifying your ability to scale. Security-focused teams will usually identify the following as problems when talking <em>PaaS</em>:</p>
<ul>
<li>The risk of <strong>data leakage / exfiltration</strong> increases as PaaS integration with <a href=https://azure.microsoft.com/en-us/overview/what-is-iaas/>IaaS</a> and on-premises environments increase</li>
<li>Decreasing or eliminating <strong>internet exposure</strong> is preferred; Azure PaaS services were originally available via public IP addresses only</li>
<li>Anything that runs over a network that isn&rsquo;t your own private <em>WAN</em> is risky and must be <strong>avoided</strong></li>
</ul>
<blockquote>
<p>While I understand and share concerns with risk here, these are generally obstacles I have run into with various security teams throughout my time in tech. I can look back on some tough conversations in the past when trying to advocate for <a href=https://www.cisco.com/c/en/us/solutions/enterprise-networks/sd-wan/what-is-sd-wan.html>SD-WAN</a>. Since it went over the <em>internet</em>, it couldn&rsquo;t be reliable and introduced significant <em>risk</em> to the business. Fast-forward to <em>2021</em> especially in the current state of the <a href=https://www.cdc.gov/coronavirus/2019-ncov/index.html>COVID-19</a> pandemic; most large enterprises now declare <em>internet</em> as the new network, <em>public cloud</em> as the new data center, and <em>identity</em> as the new perimeter.</p>
</blockquote>
<h3 id=examining-cloud-security-models>Examining Cloud Security Models</h3>
<p>Our scope here is <em>security in the cloud</em>, not <em>security of the cloud</em>. Security considerations differ in the cloud by service model. In descending through each service model&rsquo;s different layers, the responsibility for security shifts between Customer and Provider.</p>
<p>For example, with <a href=https://azure.microsoft.com/en-us/overview/what-is-saas/>SaaS</a>, the layers a customer is responsible for is relatively small; data and access/identity are considered. As you move into <a href=https://azure.microsoft.com/en-us/overview/what-is-paas/>PaaS</a>, the application layer, along with some platform configuration, comes into play. Moving into <a href=https://azure.microsoft.com/en-us/overview/what-is-iaas/>IaaS</a>, the operating system is now customer responsibility, along with all the layers above.</p>
<p><img src=/images/2021/cloud-security-and-azure-private-link/security-models.png alt="Security Models"></p>
<blockquote>
<p>When you have a nice mixture of the three cloud layers and the full gamut of all things data center, thinking through the security domain becomes complicated quickly. Add some <a href=https://en.wikipedia.org/wiki/Multicloud>Multi-Cloud</a> to this venue, and you are in for a real party.</p>
</blockquote>
<h3 id=risky-patterns>Risky Patterns</h3>
<p>In the <em>Digital Era</em>, privacy is at the top of the list. This is especially true when considering specific regulations like <a href=https://gdpr.eu/>GDPR</a> or <a href=https://www.cdc.gov/phlp/publications/topic/hipaa.html>HIPAA</a>. A data leak can cause a significant loss in revenue and long-term damage to your brand. Specific patterns can expose the number of porous areas, contributing to possible data leakage if not appropriately hardened.</p>
<ul>
<li><a href=https://azure.microsoft.com/en-us/product-categories/identity/><strong>Identity & Access Management <em>(IAM)</em></strong></a> - Access based on identity authentication and authorization controls; The ground floor for establishing <a href=https://www.microsoft.com/en-us/security/business/zero-trust>Zero Trust</a> in the public cloud</li>
<li><strong>Cloud Endpoints to On-Premises</strong> - Services in public cloud provider&rsquo;s managed network need to make calls to on-premises <em>private networks</em></li>
<li><strong>On-Premises to Cloud Endpoints</strong> - Exact opposite of the first pattern; Services in public cloud provider&rsquo;s managed network need to be called from an on-premises <em>private network</em></li>
<li><strong>Internet Egress</strong> - Any point of internet exit; A sinister concoction of data center places, <em>properly designed</em> cloud places, <em>shadow IT</em> <strong>oops</strong> cloud places, and&mldr; plenty of other venues just south of anyone&rsquo;s radar</li>
</ul>
<h2 id=a-word-on-provider-architectures>A Word On Provider Architectures</h2>
<p>For <em>public cloud</em> to achieve the massive <em>scale-out</em> which accommodates customer growth, <em>cloud services</em> are built on large pools of resources (network, compute, and storage). This large pool of resources is managed by a centralized <a href="https://en.wikipedia.org/wiki/Control_plane#:~:text=In%20computing%2C%20the%20control%20plane,that%20processes%20the%20data%20requests.">control plane</a>. As demand increases, additional <em>resources</em> are added to the pool to increase capacity.</p>
<h3 id=service-behavior>Service Behavior</h3>
<p>There are ultimately two ways in which services can be categorized based on <em>networking</em> behavior. Since this write-up is <em>Azure</em> focused, I&rsquo;ll map <em>Azure</em> specific constructs into the examples:</p>
<p><strong>Public Services</strong> is typically what we think of when referencing <em>PaaS</em>. Public Services are consumed over the internet, reachable via <em>public IP addresses</em>, and are not provisioned in the customer&rsquo;s <em>VNet</em>. An example of a <em>public service</em> would be <a href=https://azure.microsoft.com/en-us/services/storage/>Azure Storage</a>.</p>
<p><strong>Private Services</strong> by default, are not reachable over the internet. Services are assigned <a href=https://tools.ietf.org/html/rfc1918>RFC1918</a> addresses and are deployed directly inside a customer&rsquo;s virtual network. An example of a <em>private service</em> would be an <a href=https://azure.microsoft.com/en-us/services/virtual-machines/>Azure Virtual Machine</a>.</p>
<h3 id=resource-allocation>Resource Allocation</h3>
<p>When customers provision a service, the <em>control plane</em> will create an <em>instance</em> of the service. Resources are then allocated accordingly. There are generally two ways in which a <em>service</em> can allocate resources to an <em>instance</em>:</p>
<p><strong>Shared Services</strong> - Resources are allocated to more than one service instance; Each instance consumes resources <em>simultaneously</em>.</p>
<p><strong>Dedicated Services</strong> - Resources are allocated to a single instance; These resources remain dedicated for the <em>instance&rsquo;s</em> entire <em>lifecycle</em>.</p>
<p><img src=/images/2021/cloud-security-and-azure-private-link/service-allocation-patterns.png alt="Service Allocation"></p>
<h2 id=integration>Integration</h2>
<p>Suppose you are going through the cloud migration journey. In that case, you may have some strategy that includes a combination of <a href=https://aws.amazon.com/blogs/enterprise-strategy/6-strategies-for-migrating-applications-to-the-cloud/>rehost, replatform, and refactor.</a> At some point, you will probably be faced with integrating cloud <a href=https://azure.microsoft.com/en-us/overview/what-is-paas/>PaaS</a> services with <a href=https://azure.microsoft.com/en-us/overview/what-is-iaas/>IaaS</a> and even back <em>on-premises</em>.</p>
<h2 id=before-service-endpoints>Before Service Endpoints</h2>
<p><a href=https://docs.microsoft.com/en-us/azure/azure-sql/database/sql-database-paas-overview/>Azure SQL DB</a> is a great way to migrate your SQL Server databases without changing your apps, making it extremely popular. Before Service Endpoints came along, how would a <a href=https://azure.microsoft.com/en-us/services/virtual-machines/>virtual machine</a> communicate to Azure SQL?</p>
<ul>
<li>Azure SQL DB is available via public IP address and listens on port 1433</li>
<li>The virtual machine has direct connectivity to the internet via NAT&rsquo;ed IP address</li>
<li>The virtual machine leverages this for internet egress to reach Azure SQL service</li>
<li>Azure SQL service sees the NAT&rsquo;ed IP address, not the private IP of the virtual machine</li>
<li>No restrictions can be enforced to limit service ingress to your private IP addresses only</li>
</ul>
<h3 id=why-is-this-risky>Why Is This Risky?</h3>
<p>To filter traffic in this scenario, the virtual machine would need a public IP address. This presents the following complications:</p>
<ul>
<li>Virtual Machine now allows ingress directly from the internet (This is never a good practice)</li>
<li>The subnet that hosts the virtual machine would require a NAT gateway; More configuration with potential performance implications</li>
<li>Azure SQL would need to be open to clients on any network; In the event credentials are leaked, anyone on the internet could gain access</li>
</ul>
<h3 id=tradeoffs>Tradeoffs</h3>
<p>Aside from being inflexible in controlling <em>ingress</em> and <em>egress</em> traffic, the route is not optimal. Traffic is technically going out to the internet, but this is probably, in reality, routing through Azure&rsquo;s external backbone and coming back in. The service is reachable via public IP address only. Considering the design and various integrations required to make it work, there could be significant opportunities for data leakage or exfiltration.</p>
<h2 id=vnet-integration>VNet Integration</h2>
<p><a href=https://docs.microsoft.com/en-us/azure/app-service/web-sites-integrate-with-vnet>VNet Integration</a> is leveraged for services whose design matches the <em>dedicated services</em> architecture. Also called <em>VNet Injection</em>, this method deploys a given service directly in your <em>VNet</em>. As a solution, it enables better continuity for workloads operating in <em>tiered hybrid</em> design.</p>
<p><img src=/images/2021/cloud-security-and-azure-private-link/vnet-integration-diagram.png alt="VNet Integration"></p>
<h3 id=problems-solved-by-vnet-integration>Problems Solved By VNet Integration</h3>
<ul>
<li><em>Injected</em> services are exposed over <a href=https://tools.ietf.org/html/rfc1918>RFC1918</a> addresses directly from your VNet</li>
<li>As a dedicated platform, none of the components are shared across other customers; This could be a requirement in some cases</li>
<li>At the <em>network layer</em>, the behavior would be similar to that of a virtual machine in the same <em>VNet</em></li>
<li>Communication to virtual machines in same <em>VNet</em> and in <a href=https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-peering-overview>peered VNets</a> is <em>bidirectional</em></li>
<li>Communication between on-premises environments over <a href=https://docs.microsoft.com/en-us/azure/expressroute/expressroute-circuit-peerings#privatepeering>ExpressRoute - Private Peering</a> or VPNs is <em>bidirectional</em></li>
<li>Inbound connections from routable IP addresses outside of VNet address space is possible when exposed behind public IP address; Best to use an <a href="https://docs.microsoft.com/en-us/azure/load-balancer/quickstart-load-balancer-standard-public-portal?tabs=option-1-create-load-balancer-standard">external load balancer</a> / front-end IP address</li>
<li><a href=https://docs.microsoft.com/en-us/azure/load-balancer/load-balancer-outbound-connections>VNet Source NAT</a> can be used to initiate connections to internet routable IP addresses</li>
</ul>
<h3 id=vnet-integration-tradeoffs>VNet Integration Tradeoffs</h3>
<p>Although <em>VNet Integration</em> was created to deploy <a href=https://azure.microsoft.com/en-us/services/app-service/web/>App Services</a> privately, is all of it really private and <em>exclusive</em> to only your <em>VNet</em>? While the service itself is dedicated, the control plane managing the services is not. Integrated services require inbound and outbound connections to <em>platform managed</em> public IP addresses, which facilitate interaction to the <em>control plane</em>. Whether this is a tradeoff is debatable.</p>
<ul>
<li>Integrated services are deployed into an <em>isolated</em> subnet; Services contain <a href=https://docs.microsoft.com/en-us/azure/app-service/environment/network-info#ase-subnet-size>sizing guidlines</a></li>
<li>Each service identifies the required dependencies for control plane communication; For example, <a href=https://docs.microsoft.com/en-us/azure/app-service/environment/intro>App Service Environment</a> dependencies can be found <a href=https://docs.microsoft.com/en-us/azure/app-service/environment/network-info#ase-dependencies>here</a></li>
<li>Increased complexity in managing <a href=https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview>NSGs</a> and <a href=https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-udr-overview#user-defined>UDRs</a>; <a href=https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview#service-tags>Service Tags</a> should be used to reduce overhead as the mapping between tag and addresses are automatically managed by the platform</li>
<li>Ultimately, each service will exhibit different behavior and likely has different requirements; Always consult the official documentation</li>
</ul>
<h2 id=service-endpoints>Service Endpoints</h2>
<p><a href=https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview>Service Endpoints</a> as a solution can be applied to select <em>PaaS</em> services with a <em>shared architecture</em>. A route is created from your <em>PaaS</em> service into the desired <em>VNets</em>.</p>
<p><img src=/images/2021/cloud-security-and-azure-private-link/service-endpoints-diagram.png alt="Service Endpoints"></p>
<h3 id=problems-solved-by-service-endpoints>Problems Solved By Service Endpoints</h3>
<ul>
<li>After enabling a service endpoint in the subnet where the <a href=https://azure.microsoft.com/en-us/services/application-gateway/>Application Gateway</a> is deployed, source IP addresses switch from public to private IP addresses</li>
<li>Traffic from a given virtual machine in a private subnet can now talk directly to Azure SQL without requiring internet egress; Without a public IP address, bad actors can&rsquo;t scan a virtual machine&rsquo;s open ports for vulnerabilities, thus limiting application downtime and data theft</li>
<li>Service Endpoints ensure traffic egressing a given subnet is tagged with the subnet ID; Traffic inbound to Azure SQL can then be identified and blocked except for your desired subnet IDs (like the subnet which hosts the service endpoint)</li>
<li>An <a href=https://docs.microsoft.com/en-us/azure/virtual-network/network-security-groups-overview>NSG</a> can then restrict all egress traffic from the subnet to the internet, thus locking down communication both ways</li>
<li>Connecting to Azure Services from your VNet happens with an optimized route over Azure&rsquo;s internal backbone network; This reduces network hops, which increases performance (In most cases)</li>
</ul>
<h3 id=setting-up-a-service-endpoint>Setting Up A Service Endpoint</h3>
<p>When provisioning a compatible service like <a href=https://azure.microsoft.com/en-us/services/key-vault/>Azure Keyvault</a>, you will have an option to use <strong><em>Public Endpoint (Selected Networks)</em></strong> during the setup process. It will then walk you through enabling <em>service endpoints</em> on your desired virtual network and subnet.</p>
<p><img src=/images/2021/cloud-security-and-azure-private-link/service-endpoint-setup.gif alt="Service Endpoint Setup"></p>
<h3 id=dns-behavior-with-service-endpoints>DNS Behavior With Service Endpoints</h3>
<p><a href=https://en.wikipedia.org/wiki/Domain_Name_System>DNS</a> behavior remains <em>as-is</em> when leveraging <em>service endpoints</em>. DNS of a given resource will always resolve the resource&rsquo;s public IP address regardless of where the traffic originates. This is because the <em>service endpoint</em> doesn&rsquo;t change the network interface IP address of the resource it was added to. In doing a DNS lookup from an Azure virtual machine, we get a <em>CNAME</em> to <strong><em>cloudapp.net</em></strong> which gives us <strong><em>20.185.217.251</em></strong>. This lookup is identical when being executed both from the virtual machine living in the <em>VNet</em> and on my local machine at home.</p>
<p><img src=/images/2021/cloud-security-and-azure-private-link/se-dns-query.gif alt="Service Endpoints DNS Query"></p>
<h3 id=service-endpoint-tradeoffs>Service Endpoint Tradeoffs</h3>
<p>Leveraging service endpoints is an excellent way to harden your VNet and service communication; As with everything in technology, it has tradeoffs to consider.</p>
<ul>
<li>Connection initiation with service endpoints is <em>unidirectional</em>; The initiator must be inside the subnet that holds the integration</li>
<li>From a VNet&rsquo;s vantage point, <em>service endpoints</em> provide access to the entire <em>PaaS</em> service; You cannot target specific <em>instances</em> of a PaaS service</li>
<li>Once enabled on a <em>subnet</em>, clients in the subnet have <em>network level</em> access to all instances of that particular service (including those belonging to other users); To mitigate the risk of leakage or data exfiltration, <a href=https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoint-policies-overview>Service Endpoint Policies</a> should be used
<blockquote>
<p>Service Endpoint Policies enable VNet owners to control precisely which <em>instances</em> of a service type can be accessed from their VNet</p>
</blockquote>
</li>
<li>The source is now a private IP address, but the destination is still the service resource&rsquo;s public IP address; Traffic is still leaving your virtual network (Whether this is a tradeoff is debatable)</li>
<li>Service Endpoints override any <a href=https://en.wikipedia.org/wiki/Border_Gateway_Protocol>BGP</a> or <a href=https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-udr-overview>UDR</a> routes for the address prefix match of any Azure service; While this isn&rsquo;t necessarily a problem, it introduces another traffic pattern that must be accounted for
<blockquote>
<p>When a <em>service endpoint</em> is created, routes for all the public prefixes used by the service type get added to the subnet&rsquo;s route table. The <em>next-hop</em> is set to a value of <strong>VirtualNetworkServiceEndpoint</strong>. All packets that match that <em>next hop</em> are encapsulated in outer packets, which carry information about the identity of their source <em>virtual network</em>.</p>
</blockquote>
</li>
<li>Service Endpoints do not work across <a href=https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-whatis>Azure AD Tenants</a>; This is not generally a problem in smaller environments but may require a workaround in larger or non-standard environments</li>
<li>Endpoints can&rsquo;t be used for traffic originating from on-premises networks</li>
</ul>
<blockquote>
<p>When service endpoints launched, the recommended solution for connecting from on-premises was to set up <a href=https://docs.microsoft.com/en-us/azure/expressroute/expressroute-circuit-peerings#microsoftpeering>Microsoft Peering</a>, which comes with additional complexity and considerations. This would involve identifying the Azure service resource side&rsquo;s public IP addresses and allowing via <em>resource IP firewall</em> and the ExpressRoute / On-Premises firewall. Why not just use <em>internet</em> at this point?</p>
</blockquote>
<h2 id=private-link>Private Link</h2>
<p>To address additional customer demand surrounding integration and security, <a href=https://azure.microsoft.com/en-us/services/private-link/>Private Link</a> was born. It is the latest solution to integrate services with a <em>shared architecture</em>. It addresses limitations of <em>service endpoints</em> by exposing <em>PaaS</em> services via <em>private IP addresses</em> taken from a VNets <a href=https://tools.ietf.org/html/rfc1918>RFC1918</a> space.</p>
<p><img src=/images/2021/cloud-security-and-azure-private-link/private-link-diagram.png alt="Private Link"></p>
<h3 id=breaking-down-the-components>Breaking Down The Components</h3>
<ul>
<li><a href=https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-overview><strong>Virtual Networks</strong> <em>(VNets)</em></a> are created in a subscription with private address space and provide network-level containment of resources with no traffic allowed by default between any two virtual networks. Any communication between virtual networks needs to be explicitly provisioned.</li>
<li><a href=https://docs.microsoft.com/en-us/azure/private-link/private-endpoint-overview><strong>Private Endpoint</strong></a> establishes a logical relationship between a public service <em>instance</em> and a <em>NIC</em> attached to the VNet where the <em>service</em> is exposed.</li>
<li><a href=https://azure.microsoft.com/en-us/services/private-link/><strong>Private Link Service</strong></a> enables you to access Azure PaaS Services over a private endpoint. Services supported today can be found <a href=https://docs.microsoft.com/en-us/azure/private-link/private-link-overview#availability>here.</a></li>
</ul>
<h3 id=problems-solved-by-private-link>Problems Solved By Private Link</h3>
<ul>
<li>Using a <em>private endpoint</em> enables flexible <em>PaaS</em> integration with your own <em>private</em> address space</li>
<li>With no public IP addresses exposed, this means network-based <em>access restrictions</em> are not so complicated or not required at all; This simplifies network design as a whole</li>
<li><em>Private Link</em> enables on-premises clients to use existing <a href=https://docs.microsoft.com/en-us/azure/expressroute/expressroute-circuit-peerings#privatepeering>ExpressRoute Private Peering</a> or an existing <a href=https://docs.microsoft.com/en-us/azure/architecture/reference-architectures/hybrid-networking/#vpn-connection>VPN</a> to consume <em>PaaS</em> services via <em>private</em> IP addresses</li>
<li>A private endpoint is mapped to an instance of a <em>PaaS</em> resource instead of the full service meaning consumers can only connect to that specific resource; This provides additional <em>built-in</em> protection against data leakage</li>
<li>Connectivity from a designated <em>VNet</em> to a partner (inside or outside) organization&rsquo;s <em>VNet</em> is now possible; This creates new opportunities for B2B <em>(Business-to-Business)</em> which can leverage Azure native connections without the necessity for <em>public endpoints</em></li>
</ul>
<h3 id=setting-up-a-private-endpoint>Setting Up A Private Endpoint</h3>
<p>Using the <a href=https://azure.microsoft.com/en-us/services/key-vault/>Azure Keyvault</a> example again, you will have an option to use <strong><em>Private Endpoint</em></strong> during the setup process. It will then walk you through setting up all the necessary configuration for a <em>private endpoint</em> and optionally creating a <a href=https://docs.microsoft.com/en-us/azure/dns/private-dns-privatednszone>Private DNS Zone</a>. Following the defaults, it will also create the <a href=https://www.cloudflare.com/learning/dns/dns-records/dns-a-record/>A Record</a> for you.</p>
<p><img src=/images/2021/cloud-security-and-azure-private-link/private-endpoint-setup.gif alt="Private Endpoint Setup"></p>
<h3 id=dns-behavior-with-private-endpoints>DNS Behavior With Private Endpoints</h3>
<p>One of the more significant differences between <em>service endpoints</em> and <em>private endpoints</em> is with <a href=https://en.wikipedia.org/wiki/Domain_Name_System>DNS</a>. In doing a DNS lookup from an Azure virtual machine, we directly resolve the private IP address <strong><em>10.5.1.4</em></strong>. If we did this same lookup from a machine outside of our <em>VNet</em> or Azure, then we would get a <em>CNAME</em> to <strong><em>cloudapp.net</em></strong> which would then give us the public IP address of the service.</p>
<p><img src=/images/2021/cloud-security-and-azure-private-link/pe-dns-query.gif alt="Private Endpoints DNS Query"></p>
<h3 id=private-link-tradeoffs>Private Link Tradeoffs</h3>
<ul>
<li>Connection initiation with Private Link is <em>unidirectional</em>; The initiator can be multiple <em>VNets</em> or <em>on-premises</em> networks</li>
<li>As of today, NSGs are not supported on <em>private endpoints</em>; While subnets containing the <em>private endpoint</em> can have an NSG associated, the rules will not be effective on traffic being processed</li>
<li><a href=https://en.wikipedia.org/wiki/Domain_Name_System>DNS</a> integration is a major part of <em>Private Link</em> and brings additional complexity; Mapping design and configuration to outcomes requires significant planning</li>
<li>Transitioning infrastructure from <em>service endpoints</em> to <em>private endpoints</em> will require additional planning and downtime</li>
</ul>
<h3 id=expanding-on-dns-complexity>Expanding On DNS Complexity</h3>
<p>In the most simple of scenarios, an instance of a service that supports <em>Private Link</em> can be accessed concurrently through the service&rsquo;s <em>public IP address</em> and <em>private endpoint</em> (across multiple VNets). During provisioning, each <em>instance</em> of a <em>public service</em> is assigned a unique and publicly resolvable <em>FQDN</em>. With a service operating in <em>shared architecture</em>, multiple instances run on the same set of resources sharing the same <em>IP address</em>. To handle resolution, <a href=https://en.wikipedia.org/wiki/CNAME_record>CNAME</a> records map the <em>FQDNs</em> of each instance back to the same address.</p>
<p><em>Private Link</em>, by design, requires DNS behavior to change based on origin - e.g., inside/outside and also based on the existence of a <em>private endpoint</em> for a given <em>instance</em>. Since, by default, the <em>FQDN</em> of the service resolves to a public IP, you would need to configure DNS accordingly to map to the <em>private IP address</em> allocated from your <em>VNet</em>. This is a topic that should be planned out prior to leveraging this service. One consistent <em>truth</em> I have learned working in technology is, <strong><em>Some of the most bizarre problems leading to colossal time waste turn out to be misconfigured DNS</em></strong>. A great way to get ahead of these challenges is to <a href=https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances#name-resolution-that-uses-your-own-dns-server>educate on how name resolution for resources in Azure works</a> and also know your options for <a href=https://docs.microsoft.com/en-us/azure/private-link/private-endpoint-dns#on-premises-workloads-using-a-dns-forwarder>integrating with on-premises DNS.</a></p>
<h2 id=conclusion>Conclusion</h2>
<p><a href=https://docs.microsoft.com/en-us/azure/virtual-network/virtual-network-service-endpoints-overview>Service Endpoints</a> as a solution is easier to set up and manage, although integration with on-premises can be a challenge. <a href=https://azure.microsoft.com/en-us/services/private-link/>Private Link</a> is much more complex and will differ across environments. Deploying <em>Private Link</em> will require much more up-front discovery and planning around existing design, which also segues into <em>infrastructure as code</em> and possibly incorporating automation outside of <a href=https://azure.microsoft.com/en-us/>Azure</a> - (If leveraging existing DNS solution).</p>
<p><a href=https://en.wikipedia.org/wiki/Benjamin_Franklin>Benjamin Franklin</a> once said, <strong><em>&ldquo;By failing to prepare, you are preparing to fail."</em></strong> By taking that extra preparation, <em>Private Link</em> can offer much more granular control with how <em>PaaS</em> services are integrated into an environment. In the state of <em>Cybersecurity</em> post-pandemic, I predict that all the major cloud providers will <em>prioritize</em> the <em>privatization</em> of all <em>PaaS</em> endpoints.</p>
<h3 id=acknowledgements>Acknowledgements</h3>
<p>Big thanks to the wise and insightful <a href=https://www.linkedin.com/in/sthawkins/>Steven Hawkins</a> for taking the time to peer review this post.</p>
</div>
<footer class=post-footer>
<div class=post-tags>
<a href=/tags/azure/>azure</a>
<a href=/tags/dns/>dns</a>
<a href=/tags/iaas/>iaas</a>
<a href=/tags/paas/>paas</a>
<a href=/tags/private-endpoints/>private endpoints</a>
<a href=/tags/private-link/>private link</a>
<a href=/tags/public-endpoints/>public endpoints</a>
<a href=/tags/service-endpoints/>service endpoints</a>
<a href=/tags/saas/>saas</a>
</div>
<nav class=post-nav>
<a class=prev href=/post/2021/cloud-grade-automation-with-packer-and-terraform/>
<i class="iconfont icon-left"></i>
<span class="prev-text nav-default">Cloud Grade Automation With Packer and Terraform</span>
<span class="prev-text nav-mobile">Prev</span>
</a>
<a class=next href=/post/2020/automating-cloud-ipam/>
<span class="next-text nav-default">AnsibleFest 2020 - Automating IPAM In Cloud</span>
<span class="next-text nav-mobile">Next</span>
<i class="iconfont icon-right"></i>
</a>
</nav>
</footer>
</article>
</div>
</div>
</main>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9QKVT40M3H"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-9QKVT40M3H',{anonymize_ip:!1})}</script>
<footer id=footer class=footer>
<div class=social-links>
<a href=https://twitter.com/wcollins502/ class="iconfont icon-twitter" title=twitter></a>
<a href=https://www.linkedin.com/in/william-collins/ class="iconfont icon-linkedin" title=linkedin></a>
<a href=https://github.com/wcollins/ class="iconfont icon-github" title=github></a>
<a href=http://wcollins.io/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a>
</div>
<div class=copyright>
<span class=copyright-year>
&copy;
2020 -
2022<span class=division> | </span>
<span>William Collins</span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class="iconfont icon-up"></i>
</div>
</div>
<script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/main.min.2517c0eb67172a0bae917de4af59b10ca2531411a009d4c0b82f5685259e5771.js></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','G-9QKVT40M3H','auto'),ga('send','pageview'))</script>
<script async src=https://www.google-analytics.com/analytics.js></script>
</body>
</html>